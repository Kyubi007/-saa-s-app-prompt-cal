{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///Users/philippeichert/Downloads/saa-s-app-prompt-cal/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\"\nimport { cookies } from \"next/headers\"\n\nexport async function createClient() {\n  const cookieStore = await cookies()\n\n  return createServerClient(process.env.NEXT_PUBLIC_SUPABASE_URL!, process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!, {\n    cookies: {\n      getAll() {\n        return cookieStore.getAll()\n      },\n      setAll(cookiesToSet) {\n        try {\n          cookiesToSet.forEach(({ name, value, options }) => cookieStore.set(name, value, options))\n        } catch {\n          // Called from Server Component - middleware handles refresh\n        }\n      },\n    },\n  })\n}\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;;;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,4IAAO;IAEjC,OAAO,IAAA,iMAAkB,sUAAoF;QAC3G,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAAK,YAAY,GAAG,CAAC,MAAM,OAAO;gBAClF,EAAE,OAAM;gBACN,4DAA4D;gBAC9D;YACF;QACF;IACF;AACF"}},
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///Users/philippeichert/Downloads/saa-s-app-prompt-cal/lib/schemas/ai-schema.ts"],"sourcesContent":["import { z } from \"zod\"\n\n// Zod schema for AI action validation\nexport const aiActionSchema = z.discriminatedUnion(\"type\", [\n  // Create action\n  z.object({\n    type: z.literal(\"create\"),\n    title: z.string().min(1),\n    start: z.string().datetime(),\n    duration_min: z.number().int().positive(),\n    notes: z.string().optional(),\n    confidence: z.number().min(0).max(1),\n  }),\n  // Update action\n  z.object({\n    type: z.literal(\"update\"),\n    event_id: z.string().uuid(),\n    title: z.string().optional(),\n    start: z.string().datetime().optional(),\n    duration_min: z.number().int().positive().optional(),\n    notes: z.string().optional(),\n    confidence: z.number().min(0).max(1),\n  }),\n  // Delete action\n  z.object({\n    type: z.literal(\"delete\"),\n    event_id: z.string().uuid(),\n    confidence: z.number().min(0).max(1),\n  }),\n])\n\nexport const aiResponseSchema = z.object({\n  actions: z.array(aiActionSchema),\n  summary: z.string().optional(),\n})\n\nexport type ValidatedAIAction = z.infer<typeof aiActionSchema>\nexport type ValidatedAIResponse = z.infer<typeof aiResponseSchema>\n\n// JSON Schema for OpenAI structured outputs\nexport const aiJsonSchema = {\n  name: \"calendar_actions\",\n  strict: true,\n  schema: {\n    type: \"object\",\n    properties: {\n      actions: {\n        type: \"array\",\n        items: {\n          type: \"object\",\n          properties: {\n            type: {\n              type: \"string\",\n              enum: [\"create\", \"update\", \"delete\"],\n            },\n            event_id: {\n              type: \"string\",\n              description: \"UUID of existing event (required for update/delete)\",\n            },\n            title: {\n              type: \"string\",\n              description: \"Event title (required for create)\",\n            },\n            start: {\n              type: \"string\",\n              description: \"ISO 8601 datetime with timezone\",\n            },\n            duration_min: {\n              type: \"integer\",\n              description: \"Duration in minutes\",\n            },\n            notes: {\n              type: \"string\",\n              description: \"Optional notes\",\n            },\n            confidence: {\n              type: \"number\",\n              minimum: 0,\n              maximum: 1,\n              description: \"Confidence score 0-1\",\n            },\n          },\n          required: [\"type\", \"confidence\"],\n          additionalProperties: false,\n        },\n      },\n      summary: {\n        type: \"string\",\n        description: \"Brief summary of planned actions\",\n      },\n    },\n    required: [\"actions\"],\n    additionalProperties: false,\n  },\n}\n\nexport const aiEventSchema = z.object({\n  title: z.string().min(1).describe(\"Titel des Termins\"),\n  description: z.string().optional().describe(\"Optionale Beschreibung\"),\n  start_time: z.string().describe(\"ISO 8601 Startzeit mit Zeitzone\"),\n  duration_min: z.number().int().positive().describe(\"Dauer in Minuten\"),\n  category: z.enum([\"work\", \"personal\", \"health\", \"social\", \"other\"]).describe(\"Kategorie des Termins\"),\n  color: z\n    .string()\n    .regex(/^#[0-9a-fA-F]{6}$/)\n    .describe(\"Hex-Farbcode\"),\n})\n\nexport const aiEventArraySchema = z.object({\n  events: z.array(aiEventSchema).describe(\"Liste der zu erstellenden Termine\"),\n})\n\nexport type AIEvent = z.infer<typeof aiEventSchema>\nexport type AIEventArray = z.infer<typeof aiEventArraySchema>\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 200, "column": 0}, "map": {"version":3,"sources":["file:///Users/philippeichert/Downloads/saa-s-app-prompt-cal/app/api/ai/plan/route.ts"],"sourcesContent":["import { createClient } from \"@/lib/supabase/server\"\nimport { NextResponse } from \"next/server\"\nimport { generateObject } from \"ai\"\nimport { openai } from \"@ai-sdk/openai\"\nimport { aiEventArraySchema } from \"@/lib/schemas/ai-schema\"\nimport { startOfWeek, endOfWeek, addWeeks, format, parseISO } from \"date-fns\"\nimport { de } from \"date-fns/locale\"\n\nexport async function POST(request: Request) {\n  try {\n    const supabase = await createClient()\n\n    const {\n      data: { user },\n      error: authError,\n    } = await supabase.auth.getUser()\n    if (authError || !user) {\n      return NextResponse.json({ error: \"Nicht autorisiert\" }, { status: 401 })\n    }\n\n    // Check subscription status\n    const { data: subscription } = await supabase.from(\"subscriptions\").select(\"*\").eq(\"user_id\", user.id).single()\n\n    const now = new Date()\n    const isActive = true\n\n    const { prompt, timezone = \"Europe/Berlin\" } = await request.json()\n\n    if (!prompt || typeof prompt !== \"string\" || prompt.trim().length === 0) {\n      return NextResponse.json({ error: \"Prompt ist erforderlich\" }, { status: 400 })\n    }\n\n    // Get user preferences\n    const { data: preferences } = await supabase.from(\"preferences\").select(\"*\").eq(\"user_id\", user.id).single()\n\n    const workStart = preferences?.default_work_start || \"09:00\"\n    const workEnd = preferences?.default_work_end || \"17:00\"\n\n    // Get existing events for context\n    const weekStart = startOfWeek(now, { weekStartsOn: 1 })\n    const weekEnd = endOfWeek(addWeeks(now, 2), { weekStartsOn: 1 })\n\n    const { data: existingEvents } = await supabase\n      .from(\"events\")\n      .select(\"title, start_at, duration_min\")\n      .eq(\"user_id\", user.id)\n      .gte(\"start_at\", weekStart.toISOString())\n      .lte(\"start_at\", weekEnd.toISOString())\n      .order(\"start_at\", { ascending: true })\n\n    const existingEventsContext =\n      existingEvents\n        ?.map((e) => {\n          const startDate = parseISO(e.start_at)\n          const endDate = new Date(startDate.getTime() + e.duration_min * 60000)\n          return `- ${e.title}: ${format(startDate, \"EEEE d. MMM HH:mm\", { locale: de })} - ${format(endDate, \"HH:mm\", { locale: de })}`\n        })\n        .join(\"\\n\") || \"Keine bestehenden Termine\"\n\n    const systemPrompt = `Du bist ein intelligenter Kalender-Assistent für PromptCal. Deine Aufgabe ist es, natürlichsprachige Eingaben in strukturierte Kalendereinträge umzuwandeln.\n\nAKTUELLES DATUM UND ZEIT: ${format(now, \"EEEE, d. MMMM yyyy, HH:mm 'Uhr'\", { locale: de })}\nZEITZONE: ${timezone}\nARBEITSZEITEN: ${workStart} - ${workEnd}\n\nBESTEHENDE TERMINE (zur Vermeidung von Konflikten):\n${existingEventsContext}\n\nREGELN:\n1. Interpretiere relative Zeitangaben (morgen, nächste Woche, Montag) korrekt basierend auf dem aktuellen Datum\n2. Wenn keine Uhrzeit angegeben, verwende sinnvolle Standardzeiten innerhalb der Arbeitszeiten\n3. Wenn keine Dauer angegeben, schätze basierend auf dem Termintyp:\n   - Meeting/Besprechung: 60 Minuten\n   - Kurzer Call: 30 Minuten\n   - Workshop/Training: 120 Minuten\n   - Mittagessen: 60 Minuten\n   - Fokuszeit/Deep Work: 120 Minuten\n4. Vermeide Überschneidungen mit bestehenden Terminen wenn möglich\n5. Wähle passende Kategorien: work, personal, health, social, other\n6. Setze sinnvolle Farben basierend auf der Kategorie:\n   - work: #3b82f6 (blau)\n   - personal: #8b5cf6 (lila)\n   - health: #10b981 (grün)\n   - social: #f59e0b (orange)\n   - other: #6b7280 (grau)\n7. Alle Zeiten müssen als vollständige ISO 8601 Strings zurückgegeben werden\n\nAntworte NUR mit den strukturierten Kalenderdaten im angeforderten Format.`\n\n    const { object: events } = await generateObject({\n      model: openai(\"gpt-4o\", {\n        apiKey: process.env.OPENAI_API_KEY,\n      }),\n      schema: aiEventArraySchema,\n      system: systemPrompt,\n      prompt: prompt,\n    })\n\n    // Insert as drafts\n    const drafts = events.events.map((event) => ({\n      user_id: user.id,\n      title: event.title,\n      description: event.description || null,\n      start_at: event.start_time,\n      duration_min: event.duration_min || 60,\n      category: event.category,\n      color: event.color,\n      original_prompt: prompt,\n      type: \"create\" as const,\n      confidence: 1,\n      raw_action: {},\n    }))\n\n    const { data: insertedDrafts, error: insertError } = await supabase.from(\"event_drafts\").insert(drafts).select()\n\n    if (insertError) {\n      console.error(\"Error inserting drafts:\", insertError)\n      return NextResponse.json({ error: \"Fehler beim Speichern der Entwürfe\" }, { status: 500 })\n    }\n\n    return NextResponse.json({\n      drafts: insertedDrafts,\n      message: `${insertedDrafts.length} Termin${insertedDrafts.length === 1 ? \"\" : \"e\"} als Entwurf erstellt`,\n    })\n  } catch (error) {\n    console.error(\"AI Planning Error:\", error)\n    return NextResponse.json({ error: \"Fehler bei der KI-Verarbeitung\" }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}